<!DOCTYPE html>
<html>
<head>
  <title>Quiz Master</title>
  <hr>
<img src="https://postimg.cc/0MrwTQkM" alt="SASHIN ON STAGE"></img><BR>
<h3>SASHIN ON STAGE</h3>

<input id="quizTitle" placeholder="Quiz Title">
<br>
<button onclick="saveBranding()">Save Branding</button>

<p id="brandingStatus"></p>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  body {
    background: radial-gradient(circle at top, #1a1a1a, #000);
    color: #ffffff;
    font-family: "Segoe UI", Arial, sans-serif;
  }

  h2, h3 {
    margin-top: 30px;
    border-bottom: 2px solid #333;
    padding-bottom: 8px;
  }

  button {
    background: linear-gradient(135deg, #ff9800, #ff5722);
    color: #fff;
    border: none;
    padding: 14px 22px;
    margin: 6px 4px;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }

  button:hover {
    transform: scale(1.05);
  }

  input, select {
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    margin: 6px 0;
    width: 100%;
    max-width: 500px;
  }

  table {
    margin-top: 15px;
    border-collapse: collapse;
    font-size: 16px;
  }

  th {
    background: #222;
    color: #ff9800;
    padding: 10px;
  }

  td {
    background: #111;
    padding: 10px;
    text-align: center;
  }

  hr {
    border: none;
    height: 1px;
    background: #333;
    margin: 30px 0;
  }

  #roundStatus {
    font-size: 20px;
    font-weight: bold;
    margin-top: 10px;
  }

  #roundStatus::before {
    content: "‚ñ∂ ";
    color: #ff9800;
  }
</style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Firebase Config -->
  <script src="firebase.js"></script>
</head>

<body style="font-family:Arial; padding:20px;">

<h2>Quiz Master Dashboard</h2>

<button onclick="createRoom()">Create Room</button>
<h3 id="roomCode"></h3>

<hr>

<h3>Create Teams</h3>
<input id="teamName" placeholder="Team Name">
<button onclick="addTeam()">Add Team</button>
<ul id="teamList"></ul>
<hr>

<h3>Round Control</h3>

<select id="roundType">
  <option value="mcq">MCQ (A / B / C / D)</option>
  <option value="text">Type the Answer</option>
  <option value="buzz">Buzz</option>
</select>

<br><br>

<input id="questionText" placeholder="Enter Question" style="width:100%;">

<br><br>

<button onclick="startRound()">Open Answering</button>
<button onclick="closeRound()">Close Answering</button>

<input id="correctAnswer" placeholder="Correct Answer">
<button onclick="scoreRound()">Award Points</button>
<p id="roundStatus"></p>
<button onclick="resetRound()">Reset Round</button>
<button onclick="clearAllData()">End Quiz (Clear Room)</button>
<hr>

<h3>Player Responses</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Player</th>
      <th>Team</th>
      <th>Answer</th>
    </tr>
  </thead>
  <tbody id="responseList"></tbody>
</table>

<br>
<hr>

<h3>Players Joined</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Name</th>
      <th>WhatsApp</th>
      <th>Team</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody id="playerList"></tbody>
</table>


<p id="scoreStatus"></p>

<hr>

<h3>üèÜ Player Leaderboard</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Player</th>
      <th>Team</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody id="playerBoard"></tbody>
</table>

<br>

<h3>üèÜ Team Leaderboard</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Team</th>
      <th>Total Score</th>
    </tr>
  </thead>
  <tbody id="teamBoard"></tbody>
</table>
<hr>

<h3>üì§ Export Results</h3>
<button onclick="exportPlayers()">Download Player Results</button>
<button onclick="exportTeams()">Download Team Results</button>
<script>
var currentRoom = null;

/* ---------- CREATE ROOM ---------- */
function createRoom() {
  var code = Math.random().toString(36).substring(2, 6).toUpperCase();
  currentRoom = code;

  document.getElementById("roomCode").innerText =
    "Room Code: " + code;

  firebase.database().ref("rooms/" + code).set({
    status: "waiting",
    createdAt: Date.now(),
    teams: {},
    players: {}
  });

  listenForTeams();
  listenForPlayers();
  listenForResponses();
  listenForPlayerBoard();
  listenForTeamBoard();
}

/* ---------- TEAMS ---------- */
function addTeam() {
  var name = document.getElementById("teamName").value.trim();
  if (!name || !currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/teams/" + name)
    .set({ score: 0 });

  document.getElementById("teamName").value = "";
}

function listenForTeams() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/teams")
    .on("value", function(snapshot) {
      var teams = snapshot.val() || {};
      var ul = document.getElementById("teamList");
      ul.innerHTML = "";

      for (var t in teams) {
        var li = document.createElement("li");
        li.innerText = t;
        ul.appendChild(li);
      }
    });
}

/* ---------- ROUND CONTROL ---------- */
function startRound() {
  if (!currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/round")
    .set({
      type: document.getElementById("roundType").value,
      question: document.getElementById("questionText").value,
      status: "open",
      startedAt: Date.now()
    });

  document.getElementById("roundStatus").innerText =
    "Answering OPEN";
}

function closeRound() {
  if (!currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/round/status")
    .set("closed");

  document.getElementById("roundStatus").innerText =
    "Answering CLOSED";
}

/* ---------- PLAYERS ---------- */
function listenForPlayers() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/players")
    .on("value", function(snapshot) {
      var players = snapshot.val() || {};
      var tbody = document.getElementById("playerList");
      tbody.innerHTML = "";

      for (var k in players) {
        var p = players[k];
        var row = document.createElement("tr");

        ["name","whatsapp","team","score"].forEach(function(key){
          var td = document.createElement("td");
          td.innerText = p[key];
          row.appendChild(td);
        });

        tbody.appendChild(row);
      }
    });
}

/* ---------- RESPONSES ---------- */
function listenForResponses() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/responses")
    .on("value", function(snapshot) {
      var responses = snapshot.val() || {};
      var tbody = document.getElementById("responseList");
      tbody.innerHTML = "";

      for (var k in responses) {
        var r = responses[k];
        var row = document.createElement("tr");

        ["player","team","answer"].forEach(function(field){
          var td = document.createElement("td");
          td.innerText =
            field === "player" ? "Player" : r[field];
          row.appendChild(td);
        });

        tbody.appendChild(row);
      }
    });
}

/* ---------- SCORING ---------- */
function scoreRound() {
  var correct = document.getElementById("correctAnswer").value.trim().toLowerCase();
  if (!correct) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/responses")
    .once("value", function(snapshot) {
      var responses = snapshot.val() || {};

      for (var pid in responses) {
        if (
          String(responses[pid].answer).toLowerCase() === correct
        ) {
          awardPoints(pid, responses[pid].team);
        }
      }

      document.getElementById("scoreStatus").innerText =
        "Scoring completed";
    });
}

function awardPoints(playerId, team) {
  firebase.database()
    .ref("rooms/" + currentRoom + "/players/" + playerId + "/score")
    .transaction(function(s){ return (s || 0) + 10; });

  firebase.database()
    .ref("rooms/" + currentRoom + "/teams/" + team + "/score")
    .transaction(function(s){ return (s || 0) + 10; });
}

/* ---------- LEADERBOARDS ---------- */
function listenForPlayerBoard() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/players")
    .on("value", function(snapshot) {
      var players = snapshot.val() || {};
      var list = Object.values(players)
        .sort(function(a,b){ return b.score - a.score; });

      var tbody = document.getElementById("playerBoard");
      tbody.innerHTML = "";

      list.forEach(function(p){
        var row = document.createElement("tr");
        ["name","team","score"].forEach(function(k){
          var td = document.createElement("td");
          td.innerText = p[k];
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
    });
}

function listenForTeamBoard() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/teams")
    .on("value", function(snapshot) {
      var teams = snapshot.val() || {};
      var list = Object.keys(teams)
        .map(function(t){
          return { name:t, score:teams[t].score };
        })
        .sort(function(a,b){ return b.score - a.score; });

      var tbody = document.getElementById("teamBoard");
      tbody.innerHTML = "";

      list.forEach(function(t){
        var row = document.createElement("tr");

        var td1 = document.createElement("td");
        td1.innerText = t.name;

        var td2 = document.createElement("td");
        td2.innerText = t.score;

        row.appendChild(td1);
        row.appendChild(td2);
        tbody.appendChild(row);
      });
    });
}

  /* ---------- RESET ROUND ---------- */
function resetRound() {
  if (!currentRoom) return;

  // Remove answers, buzz & close round
  firebase.database().ref("rooms/" + currentRoom + "/responses").remove();
  firebase.database().ref("rooms/" + currentRoom + "/buzz").remove();
  firebase.database().ref("rooms/" + currentRoom + "/round/status").set("closed");

  document.getElementById("roundStatus").innerText =
    "Round reset. Ready for next question.";

  document.getElementById("correctAnswer").value = "";
}

/* ---------- CLEAR ENTIRE ROOM ---------- */
function clearAllData() {
  if (!currentRoom) return;

  if (!confirm("This will end the quiz and clear the room. Continue?")) {
    return;
  }

  firebase.database().ref("rooms/" + currentRoom).remove();

  document.getElementById("roomCode").innerText = "";
  document.getElementById("roundStatus").innerText = "Quiz ended";
}
/* ---------- EXPORT PLAYERS ---------- */
function exportPlayers() {
  if (!currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/players")
    .once("value", function(snapshot) {
      const players = snapshot.val() || {};
      let csv = "Name,WhatsApp,Team,Score\n";

      for (let id in players) {
        const p = players[id];
        csv += `"${p.name}","${p.whatsapp}","${p.team}",${p.score}\n`;
      }

      downloadCSV(csv, "player_results_" + currentRoom + ".csv");
    });
}

/* ---------- EXPORT TEAMS ---------- */
function exportTeams() {
  if (!currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/teams")
    .once("value", function(snapshot) {
      const teams = snapshot.val() || {};
      let csv = "Team,Score\n";

      for (let t in teams) {
        csv += `"${t}",${teams[t].score}\n`;
      }

      downloadCSV(csv, "team_results_" + currentRoom + ".csv");
    });
}

/* ---------- DOWNLOAD HELPER ---------- */
function downloadCSV(content, fileName) {
  const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

  firebase.database()
  .ref("rooms/" + currentRoom + "/buzz")
  .on("value", function(snapshot) {
    if (snapshot.exists()) {
      document.getElementById("buzzSound").play();
    }
  });
/* ---------- BRANDING ---------- */
function saveBranding() {
  if (!currentRoom) return;

  const title = document.getElementById("quizTitle").value;
  const logo = document.getElementById("logoUrl").value;

  firebase.database()
    .ref("rooms/" + currentRoom + "/branding")
    .set({
      title: title,
      logo: logo
    });

  document.getElementById("brandingStatus").innerText =
    "Branding saved";
}

</script>
<audio id="buzzSound">
  <source src="https://assets.mixkit.co/active_storage/sfx/2067/2067-preview.mp3" type="audio/mpeg">
</audio>

</body>
</html>
