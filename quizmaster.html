<!DOCTYPE html>
<html>
<head>
  <title>Quiz Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Firebase Config -->
  <script src="firebase.js"></script>
</head>

<body style="font-family:Arial; padding:20px;">

<h2>Quiz Master Dashboard</h2>

<button onclick="createRoom()">Create Room</button>
<h3 id="roomCode"></h3>

<hr>

<h3>Create Teams</h3>
<input id="teamName" placeholder="Team Name">
<button onclick="addTeam()">Add Team</button>
<ul id="teamList"></ul>
<hr>

<h3>Round Control</h3>

<select id="roundType">
  <option value="mcq">MCQ (A / B / C / D)</option>
  <option value="text">Type the Answer</option>
  <option value="buzz">Buzz</option>
</select>

<br><br>

<input id="questionText" placeholder="Enter Question" style="width:100%;">

<br><br>

<button onclick="startRound()">Open Answering</button>
<button onclick="closeRound()">Close Answering</button>

<p id="roundStatus"></p>

<hr>

<h3>Player Responses</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Player</th>
      <th>Team</th>
      <th>Answer</th>
    </tr>
  </thead>
  <tbody id="responseList"></tbody>
</table>

<br>
<hr>

<h3>Players Joined</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Name</th>
      <th>WhatsApp</th>
      <th>Team</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody id="playerList"></tbody>
</table>


<input id="correctAnswer" placeholder="Correct Answer">
<button onclick="scoreRound()">Award Points</button>

<p id="scoreStatus"></p>

<hr>

<h3>üèÜ Player Leaderboard</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Player</th>
      <th>Team</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody id="playerBoard"></tbody>
</table>

<br>

<h3>üèÜ Team Leaderboard</h3>
<table border="1" width="100%">
  <thead>
    <tr>
      <th>Team</th>
      <th>Total Score</th>
    </tr>
  </thead>
  <tbody id="teamBoard"></tbody>
</table>

<script>
var currentRoom = null;

/* ---------- CREATE ROOM ---------- */
function createRoom() {
  var code = Math.random().toString(36).substring(2, 6).toUpperCase();
  currentRoom = code;

  document.getElementById("roomCode").innerText =
    "Room Code: " + code;

  firebase.database().ref("rooms/" + code).set({
    status: "waiting",
    createdAt: Date.now(),
    teams: {},
    players: {}
  });

  listenForTeams();
  listenForPlayers();
  listenForResponses();
  listenForPlayerBoard();
  listenForTeamBoard();
}

/* ---------- TEAMS ---------- */
function addTeam() {
  var name = document.getElementById("teamName").value.trim();
  if (!name || !currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/teams/" + name)
    .set({ score: 0 });

  document.getElementById("teamName").value = "";
}

function listenForTeams() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/teams")
    .on("value", function(snapshot) {
      var teams = snapshot.val() || {};
      var ul = document.getElementById("teamList");
      ul.innerHTML = "";

      for (var t in teams) {
        var li = document.createElement("li");
        li.innerText = t;
        ul.appendChild(li);
      }
    });
}

/* ---------- ROUND CONTROL ---------- */
function startRound() {
  if (!currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/round")
    .set({
      type: document.getElementById("roundType").value,
      question: document.getElementById("questionText").value,
      status: "open",
      startedAt: Date.now()
    });

  document.getElementById("roundStatus").innerText =
    "Answering OPEN";
}

function closeRound() {
  if (!currentRoom) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/round/status")
    .set("closed");

  document.getElementById("roundStatus").innerText =
    "Answering CLOSED";
}

/* ---------- PLAYERS ---------- */
function listenForPlayers() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/players")
    .on("value", function(snapshot) {
      var players = snapshot.val() || {};
      var tbody = document.getElementById("playerList");
      tbody.innerHTML = "";

      for (var k in players) {
        var p = players[k];
        var row = document.createElement("tr");

        ["name","whatsapp","team","score"].forEach(function(key){
          var td = document.createElement("td");
          td.innerText = p[key];
          row.appendChild(td);
        });

        tbody.appendChild(row);
      }
    });
}

/* ---------- RESPONSES ---------- */
function listenForResponses() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/responses")
    .on("value", function(snapshot) {
      var responses = snapshot.val() || {};
      var tbody = document.getElementById("responseList");
      tbody.innerHTML = "";

      for (var k in responses) {
        var r = responses[k];
        var row = document.createElement("tr");

        ["player","team","answer"].forEach(function(field){
          var td = document.createElement("td");
          td.innerText =
            field === "player" ? "Player" : r[field];
          row.appendChild(td);
        });

        tbody.appendChild(row);
      }
    });
}

/* ---------- SCORING ---------- */
function scoreRound() {
  var correct = document.getElementById("correctAnswer").value.trim().toLowerCase();
  if (!correct) return;

  firebase.database()
    .ref("rooms/" + currentRoom + "/responses")
    .once("value", function(snapshot) {
      var responses = snapshot.val() || {};

      for (var pid in responses) {
        if (
          String(responses[pid].answer).toLowerCase() === correct
        ) {
          awardPoints(pid, responses[pid].team);
        }
      }

      document.getElementById("scoreStatus").innerText =
        "Scoring completed";
    });
}

function awardPoints(playerId, team) {
  firebase.database()
    .ref("rooms/" + currentRoom + "/players/" + playerId + "/score")
    .transaction(function(s){ return (s || 0) + 10; });

  firebase.database()
    .ref("rooms/" + currentRoom + "/teams/" + team + "/score")
    .transaction(function(s){ return (s || 0) + 10; });
}

/* ---------- LEADERBOARDS ---------- */
function listenForPlayerBoard() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/players")
    .on("value", function(snapshot) {
      var players = snapshot.val() || {};
      var list = Object.values(players)
        .sort(function(a,b){ return b.score - a.score; });

      var tbody = document.getElementById("playerBoard");
      tbody.innerHTML = "";

      list.forEach(function(p){
        var row = document.createElement("tr");
        ["name","team","score"].forEach(function(k){
          var td = document.createElement("td");
          td.innerText = p[k];
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
    });
}

function listenForTeamBoard() {
  firebase.database()
    .ref("rooms/" + currentRoom + "/teams")
    .on("value", function(snapshot) {
      var teams = snapshot.val() || {};
      var list = Object.keys(teams)
        .map(function(t){
          return { name:t, score:teams[t].score };
        })
        .sort(function(a,b){ return b.score - a.score; });

      var tbody = document.getElementById("teamBoard");
      tbody.innerHTML = "";

      list.forEach(function(t){
        var row = document.createElement("tr");

        var td1 = document.createElement("td");
        td1.innerText = t.name;

        var td2 = document.createElement("td");
        td2.innerText = t.score;

        row.appendChild(td1);
        row.appendChild(td2);
        tbody.appendChild(row);
      });
    });
}
</script>

</body>
</html>
