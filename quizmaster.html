<!DOCTYPE html>
<html>
<head>
  <title>Quiz Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: radial-gradient(circle at top, #1a1a1a, #000);
      color: #fff;
      font-family: "Segoe UI", Arial, sans-serif;
      padding: 20px;
    }
    h2, h3 {
      border-bottom: 2px solid #333;
      padding-bottom: 6px;
      margin-top: 30px;
    }
    button {
      background: linear-gradient(135deg, #ff9800, #ff5722);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px;
    }
    input, select {
      padding: 12px;
      border-radius: 8px;
      border: none;
      margin: 6px 0;
      width: 100%;
      max-width: 500px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #333;
      padding: 10px;
      text-align: center;
    }
    th { background:#222; color:#ff9800; }
    hr { border:none; height:1px; background:#333; margin:30px 0; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="firebase.js"></script>
</head>

<body>

<!-- BRAND HEADER -->
<div style="display:flex; align-items:center; gap:20px;">
  <img src="https://i.postimg.cc/63ffG2F0/Sashin-On-Stage.png"
       style="height:80px; border-radius:12px;">
  <h2>SASHIN ON STAGE</h2>
</div>

<hr>

<h3>üé® Branding</h3>
<input id="quizTitle" placeholder="Quiz Title">
<button onclick="saveBranding()">Save Branding</button>
<p id="brandingStatus"></p>

<hr>

<h2>Quiz Master Dashboard</h2>
<button onclick="createRoom()">Create Room</button>
<h3 id="roomCode"></h3>

<hr>

<h3>Create Teams</h3>
<input id="teamName" placeholder="Team Name">
<button onclick="addTeam()">Add Team</button>
<ul id="teamList"></ul>

<hr>

<h3>üìÇ Import Quiz (CSV)</h3>
<input type="file" id="quizFile" accept=".csv">
<br>
<button onclick="loadQuizFile()">Load Quiz</button>
<button onclick="nextQuestion()">Next Question</button>
<p id="quizImportStatus"></p>

<hr>

<h3>Round Control</h3>
<select id="roundType">
  <option value="mcq">MCQ</option>
  <option value="text">Text</option>
  <option value="buzz">Buzz</option>
</select>

<input id="questionText" placeholder="Question">
<input id="correctAnswer" placeholder="Correct Answer">

<br>
<button onclick="startRound()">Open Answering</button>
<button onclick="closeRound()">Close Answering</button>
<button onclick="scoreRound()">Award Points</button>
<button onclick="resetRound()">Reset Round</button>
<button onclick="clearAllData()">End Quiz</button>

<p id="roundStatus"></p>

<hr>

<h3>Players Joined</h3>
<table>
<thead><tr><th>Name</th><th>WhatsApp</th><th>Team</th><th>Score</th></tr></thead>
<tbody id="playerList"></tbody>
</table>

<hr>

<h3>Player Responses</h3>
<table>
<thead><tr><th>Player</th><th>Team</th><th>Answer</th></tr></thead>
<tbody id="responseList"></tbody>
</table>

<hr>

<h3>üèÜ Player Leaderboard</h3>
<table>
<thead><tr><th>Name</th><th>Team</th><th>Score</th></tr></thead>
<tbody id="playerBoard"></tbody>
</table>

<h3>üèÜ Team Leaderboard</h3>
<table>
<thead><tr><th>Team</th><th>Score</th></tr></thead>
<tbody id="teamBoard"></tbody>
</table>

<hr>

<h3>üì§ Export</h3>
<button onclick="exportPlayers()">Players CSV</button>
<button onclick="exportTeams()">Teams CSV</button>

<script>
/* GLOBALS */
var currentRoom = null;
var quizData = [];
var currentQuestionIndex = -1;

/* ROOM */
function createRoom() {
  currentRoom = Math.random().toString(36).substring(2,6).toUpperCase();
  document.getElementById("roomCode").innerText = "Room: " + currentRoom;

  firebase.database().ref("rooms/"+currentRoom).set({
    teams:{}, players:{}
  });

  listenForTeams();
  listenForPlayers();
  listenForResponses();
  listenForPlayerBoard();
  listenForTeamBoard();
}

/* TEAMS */
function addTeam() {
  var name = teamName.value.trim();
  if(!name || !currentRoom) return;
  firebase.database().ref("rooms/"+currentRoom+"/teams/"+name).set({score:0});
  teamName.value="";
}

function listenForTeams(){
  firebase.database().ref("rooms/"+currentRoom+"/teams").on("value",s=>{
    teamList.innerHTML="";
    var t=s.val()||{};
    for(let k in t){ teamList.innerHTML+="<li>"+k+"</li>"; }
  });
}

/* ROUND */
function startRound(){
  firebase.database().ref("rooms/"+currentRoom+"/round").set({
    type:roundType.value,
    question:questionText.value,
    status:"open"
  });
  roundStatus.innerText="OPEN";
}
function closeRound(){
  firebase.database().ref("rooms/"+currentRoom+"/round/status").set("closed");
  roundStatus.innerText="CLOSED";
}
function resetRound(){
  firebase.database().ref("rooms/"+currentRoom+"/responses").remove();
  roundStatus.innerText="RESET";
}

/* PLAYERS */
function listenForPlayers(){
  firebase.database().ref("rooms/"+currentRoom+"/players").on("value",s=>{
    playerList.innerHTML="";
    var p=s.val()||{};
    for(let k in p){
      playerList.innerHTML+=`<tr><td>${p[k].name}</td><td>${p[k].whatsapp}</td><td>${p[k].team}</td><td>${p[k].score||0}</td></tr>`;
    }
  });
}

/* RESPONSES */
function listenForResponses(){
  firebase.database().ref("rooms/"+currentRoom+"/responses").on("value",s=>{
    responseList.innerHTML="";
    var r=s.val()||{};
    for(let k in r){
      responseList.innerHTML+=`<tr><td>Player</td><td>${r[k].team}</td><td>${r[k].answer}</td></tr>`;
    }
  });
}

/* SCORING */
function scoreRound(){
  var correct = correctAnswer.value.toLowerCase();
  firebase.database().ref("rooms/"+currentRoom+"/responses").once("value",s=>{
    var r=s.val()||{};
    for(let k in r){
      if(r[k].answer.toLowerCase()===correct){
        firebase.database().ref("rooms/"+currentRoom+"/players/"+k+"/score").transaction(v=>(v||0)+10);
        firebase.database().ref("rooms/"+currentRoom+"/teams/"+r[k].team+"/score").transaction(v=>(v||0)+10);
      }
    }
  });
}

/* LEADERBOARDS */
function listenForPlayerBoard(){
  firebase.database().ref("rooms/"+currentRoom+"/players").on("value",s=>{
    playerBoard.innerHTML="";
    var p=Object.values(s.val()||{}).sort((a,b)=>(b.score||0)-(a.score||0));
    p.forEach(x=>playerBoard.innerHTML+=`<tr><td>${x.name}</td><td>${x.team}</td><td>${x.score||0}</td></tr>`);
  });
}
function listenForTeamBoard(){
  firebase.database().ref("rooms/"+currentRoom+"/teams").on("value",s=>{
    teamBoard.innerHTML="";
    var t=s.val()||{};
    for(let k in t){
      teamBoard.innerHTML+=`<tr><td>${k}</td><td>${t[k].score||0}</td></tr>`;
    }
  });
}

/* EXPORT */
function exportPlayers(){
  firebase.database().ref("rooms/"+currentRoom+"/players").once("value",s=>{
    let csv="Name,WhatsApp,Team,Score\n";
    var p=s.val()||{};
    for(let k in p){
      csv+=`${p[k].name},${p[k].whatsapp},${p[k].team},${p[k].score||0}\n`;
    }
    downloadCSV(csv,"players.csv");
  });
}
function exportTeams(){
  firebase.database().ref("rooms/"+currentRoom+"/teams").once("value",s=>{
    let csv="Team,Score\n";
    var t=s.val()||{};
    for(let k in t){ csv+=`${k},${t[k].score||0}\n`; }
    downloadCSV(csv,"teams.csv");
  });
}
function downloadCSV(c,f){
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([c],{type:"text/csv"}));
  a.download=f; a.click();
}

/* BRANDING */
function saveBranding(){
  if(!currentRoom) return;
  firebase.database().ref("rooms/"+currentRoom+"/branding").set({
    title:quizTitle.value
  });
  brandingStatus.innerText="Saved";
}

/* QUIZ IMPORT */
function loadQuizFile(){
  var file=quizFile.files[0];
  if(!file) return;
  var reader=new FileReader();
  reader.onload=e=>{
    quizData=[];
    var lines=e.target.result.replace(/\r/g,"").split("\n");
    for(let i=1;i<lines.length;i++){
      if(!lines[i]) continue;
      var p=lines[i].split(",");
      quizData.push({type:p[0].trim(),question:p[1].trim(),answer:p.slice(2).join(",").trim()});
    }
    currentQuestionIndex=-1;
    quizImportStatus.innerText="Loaded "+quizData.length+" questions";
  };
  reader.readAsText(file);
}

function nextQuestion(){
  currentQuestionIndex++;

  if(currentQuestionIndex >= quizData.length){
    quizImportStatus.innerText = "Quiz done";
    return;
  }

  var q = quizData[currentQuestionIndex];

  // ‚úÖ NORMALIZE TYPE
  var type = q.type.toLowerCase().trim();

  if (type === "mcq" || type === "m") {
    type = "mcq";
  } else if (type === "text" || type === "t") {
    type = "text";
  } else if (type === "buzz" || type === "b") {
    type = "buzz";
  } else {
    alert("Invalid quiz type in CSV: " + q.type);
    return;
  }

  // ‚úÖ FORCE SELECT UPDATE
  roundType.value = type;

  questionText.value = q.question;
  correctAnswer.value = q.answer;

  quizImportStatus.innerText =
    "Question " + (currentQuestionIndex + 1) + " (" + type.toUpperCase() + ")";
}

</script>

</body>
</html>
